* TODO cloxy - stuff to do [60%]

** DONE check (and document) that we can access the omdbapi
CLOSED: [2012-12-01 Sat 16:41]
** DONE listen (and reply) on a port (hello world)
CLOSED: [2012-12-01 Sat 17:10]
** FAIL look for a middleware that would do proxy
CLOSED: [2012-12-04 Tue 09:17]

nothing found

** DONE compare raw http and ring http
CLOSED: [2012-12-04 Tue 08:45]

*** ref
**** canonical query
***** request
#+begin_src sh
curl http://localhost:3009/solr/update?foo=bar -H 'Content-type:text/xml' --data-binary '<commit/>'
#+end_src
***** received on the fake server
#+begin_src sh
POST /solr/update?foo=bar HTTP/1.1
User-Agent: curl/7.21.3 (i686-pc-linux-gnu) libcurl/7.21.3 OpenSSL/0.9.8o zlib/1.2.3.4 libidn/1.18
Host: localhost:9090
Accept: */*
Content-type:text/xml
Content-Length: 9
<commit/>
#+end_src
***** received on the ring server
#+begin_src sh
{:ssl-client-cert nil            ,
 :remote-addr     "127.0.0.1"    ,
 :scheme          :http          ,
 :request-method  :post          ,
 :query-string    "foo=bar"      ,
 :content-type    "text/xml"     ,
 :uri             "/solr/update" ,
 :server-name     "localhost"    ,
 :headers
 {"user-agent"     "curl/7.21.3 (i686-pc-linux-gnu) libcurl/7.21.3 OpenSSL/0.9.8o zlib/1.2.3.4 libidn/1.18" ,
  "content-type"   "text/xml"                                                                               ,
  "content-length" "9"                                                                                      ,
  "accept"         "*/*"                                                                                    ,
  "host"           "localhost:3009"}                                                                        ,
 :content-length     9       ,
 :server-port        3009    ,
 :character-encoding "UTF-8" ,
 :body               #<HttpInput org.eclipse.jetty.server.HttpInput@9d10ab>}
#+end_src
***** comp
|-------------------------+-----------------+---------------------------+--------------------------------------------------------|
|                         | fake            | ring key                  | ring value                                             |
|-------------------------+-----------------+---------------------------+--------------------------------------------------------|
| method                  | POST            | :request-method           | :post                                                  |
|-------------------------+-----------------+---------------------------+--------------------------------------------------------|
| uri                     | /solr/update    | :uri                      | "/solr/update"                                         |
|-------------------------+-----------------+---------------------------+--------------------------------------------------------|
| req param               | ?foo=bar        | :query-string             | "foo=bar"                                              |
|-------------------------+-----------------+---------------------------+--------------------------------------------------------|
| scheme                  | HTTP/1.1        | :scheme                   | :http                                                  |
|-------------------------+-----------------+---------------------------+--------------------------------------------------------|
| headers User-Agent:     | curl/7.21.3 ... | :headers "user-agent"     | "curl/7.21.3 ... "                                     |
| headers Host:           | localhost:9090  | :headers "host"           | "localhost:3009"                                       |
| headers Accept:         | */*             | :headers "accept"         | "*/*"                                                  |
| headers Content-type:   | text/xml        | :headers "content-type"   | "text/xml"                                             |
| headers Content-Length: | 9               | :headers "content-length" | "9"                                                    |
|-------------------------+-----------------+---------------------------+--------------------------------------------------------|
| body                    | <commit/>       | :body                     | #<HttpInput org.eclipse.jetty.server.HttpInput@9d10ab> |
|-------------------------+-----------------+---------------------------+--------------------------------------------------------|







** DONE in the server: get *all* text info from the client
CLOSED: [2012-12-04 Tue 09:16]
** DONE implement a proxy that if receive /fake-server will send it to localhost:9090/ [100%]
CLOSED: [2012-12-04 Tue 21:08]
*** DONE Find a way to recompile without the "port used" exception
CLOSED: [2012-12-04 Tue 16:15]
What I want:
- define jetty-server (also start it)



*** DONE actual work
CLOSED: [2012-12-04 Tue 21:08]
** DONE bugfix: the proxy loses the req params
CLOSED: [2012-12-10 Mon 07:57]
** DONE transmit the query to omdbapi
CLOSED: [2012-12-11 Tue 09:15]
** DONE check that talking to omdbapi with/out the proxy is the same (from the client perspective)
CLOSED: [2012-12-19 Wed 08:13]

*** original req
#+begin_src clj
{:trace-redirects ["http://www.omdbapi.com/?t=True%20Grit&y=1969"],
 :request-time 246,
 :status 200,
 :headers
 {"access-control-allow-origin" "*",
  "server" "Microsoft-IIS/7.5",
  "content-type" "text/html; charset=utf-8",
  "date" "Tue, 11 Dec 2012 08:16:06 GMT",
  "cache-control" "no-cache",
  "expires" "-1",
  "x-powered-by" "ASP.NET",
  "content-length" "598",
  "pragma" "no-cache",
  "connection" "close",
  "x-aspnet-version" "4.0.30319"},
 :body
 {:Director "Henry Hathaway",
  :imdbVotes "21,124",
  :Year "1969",
  :Released "11 Jun 1969",
  :Writer "Charles Portis, Marguerite Roberts",
  :imdbRating "7.3",
  :Response "True",
  :Genre "Adventure, Western, Drama",
  :imdbID "tt0065126",
  :Actors "John Wayne, Kim Darby, Glen Campbell, Jeremy Slate",
  :Rated "G",
  :Plot
  "A drunken, hard-nosed U.S. Marshal and a Texas Ranger help a stubborn young woman track down her father's murderer in Indian territory.",
  :Poster
  "http://ia.media-imdb.com/images/M/MV5BMTYwNTE3NDYzOV5BMl5BanBnXkFtZTcwNTU5MzY0MQ@@._V1_SX300.jpg",
  :Title "True Grit",
  :Runtime "2 h 8 min"}}
#+end_src

*** proxied req
#+begin_src clojure
{:trace-redirects ["http://localhost:3009/o/?t=True%20Grit&y=1969"],
 :request-time 292,
 :status 200,
 :headers
 {"access-control-allow-origin" "*",
  "server" ("Microsoft-IIS/7.5" "Jetty(7.6.1.v20120215)"),
  "content-type" "text/html;charset=UTF-8",
  "date"
  ("Tue, 11 Dec 2012 08:17:14 GMT" "Tue, 11 Dec 2012 08:16:30 GMT"),
  "cache-control" "no-cache",
  "expires" "-1",
  "x-powered-by" "ASP.NET",
  "content-length" "598",
  "pragma" "no-cache",
  "connection" "close",
  "x-aspnet-version" "4.0.30319"},
 :body
 {:Director "Henry Hathaway",
  :imdbVotes "21,124",
  :Year "1969",
  :Released "11 Jun 1969",
  :Writer "Charles Portis, Marguerite Roberts",
  :imdbRating "7.3",
  :Response "True",
  :Genre "Adventure, Western, Drama",
  :imdbID "tt0065126",
  :Actors "John Wayne, Kim Darby, Glen Campbell, Jeremy Slate",
  :Rated "G",
  :Plot
  "A drunken, hard-nosed U.S. Marshal and a Texas Ranger help a stubborn young woman track down her father's murderer in Indian territory.",
  :Poster
  "http://ia.media-imdb.com/images/M/MV5BMTYwNTE3NDYzOV5BMl5BanBnXkFtZTcwNTU5MzY0MQ@@._V1_SX300.jpg",
  :Title "True Grit",
  :Runtime "2 h 8 min"}}
#+end_src
** IN-PROGRESS test the omdbapi but with an out of process tool (curl) [%]
*** IN-PROGRESS write a test with curl that compare the proxy response and the omdbapi one



** TODO record the request response client->omdbapi [%]

** TODO instead of contacting the omdbapi, returns the recorded response

** TODO to order [0%]

*** TODO we need to be able to test locally, so we need a predictable server locally.

We could try the apache console maven archetype

*** TODO need to test with an actual payload
** TODO misc [0%]
*** TODO rename core.clj something better
*** TODO project renaming?
- I guess cloxy is too "clojure connoted"
- yaxy (yack + proxy)
* TODO notes [%]
** There is two big topics:
*** The proxying

How to be a intermediary server between a (several?) client and a
(several?) server.

How to encode the routing (one proxy, several servers), ...


*** The modification of the HTTP streams

This is ortogonal to the proxying.

How to store them, replay them, ...

